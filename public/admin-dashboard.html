<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FixRoute Admin Dashboard</title>
  
   
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet">

  <style>
   .navlinkholder{margin-top: 3rem;}
    .sidebar { width:260px; position:fixed; top:0; bottom:0; left:0; padding:20px; background:#000000; border-right:1px solid #000000; overflow-y:auto; }
    .sidebar .nav-link { color:#9ca3af; margin:6px 0; padding:10px; border-radius:6px; }
    .sidebar .nav-link.active, .sidebar .nav-link:hover { background:#1f2937; color:orangered; }
    .content-area { margin-left:270px; padding:20px; }
    .card-box { background:rgb(0, 0, 0);  border-radius:10px; padding:15px; }
    .tableBox { background:#1f2937; padding:10px; border-radius:10px;margin-top: 2rem; }
  </style>
</head>
<body>
   <nav class="navbar navbar-expand-sm bg-black sticky-top py-1">
      <div class="container navedit">
        <a class="navbar-brand text-white" href="#"><span class="display-6 fw-bold">Fix</span><span class="display-5">Route</span></a>
        <button class="bi bi-list d-lg-none d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"></button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
       
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0 navul d-md-none">
            

            <!-- BOOKINGS will be handled by JS to load contents -->
             <li class="nav-item">
             
      <a class="nav-link" data-sec="dashboard">Dashboard</a>
   
            </li>
             <li class="nav-item">
             
    <a class="nav-link" data-sec="users">Users</a>
   
            </li>
            <li class="nav-item">

             <a class="nav-link" data-sec="create-user">‚ûï Create User</a>
             </li>
             <li class="nav-item">
             
     <a class="nav-link" data-sec="technicians">Technicians</a>
   
            </li>
             <li class="nav-item">

             <a class="nav-link" data-sec="create-tech">‚ûï Create Technician</a>
             </li>
             <li class="nav-item">
              <a class="nav-link" data-sec="bookings">Bookings</a>
    
   
            </li>
             <li class="nav-item">
             
     <a class="nav-link" data-sec="bills">Bills</a>
   
            </li>
             <li class="nav-item">
             
    <a class="nav-link" data-sec="analytics">Analytics</a>
   
            </li>
             <li class="nav-item">
             
     <a class="nav-link" data-sec="heatmap">Heatmap</a>
   
            </li>
             <li class="nav-item">
             
    <a class="nav-link" data-sec="performance">Performance</a>
   
            </li>
             <li class="nav-item">
   
             <a class="nav-link" data-sec="alerts">Failed Alerts</a>
   
            </li>
             <li class="nav-item">
             
  <a class="nav-link" data-sec="audit">Audit Logs</a>
   
            </li>

             
          </ul>
             <ul class="navbar-nav ms-auto mb-2 mb-lg-0 navul">


            <!-- BOOKINGS will be handled by JS to load contents -->
             <li class="nav-item">
             
      <input 
        id="searchInput"
        class="form-control"
        placeholder="Search for Users,Service..."
        onkeyup="applySearch()"
        style="max-width:300px;"
      />
   
            </li>

             
          </ul>
        </div>
      </div>
    </nav>

  <div class="sidebar d-none d-md-block">
    
    <hr class="border-secondary">
    <div class="navlinkholder">
    <a class="nav-link" data-sec="dashboard">Dashboard</a>
    <a class="nav-link" data-sec="users">Users</a>
     <a class="nav-link" data-sec="create-user">‚ûï Create User</a>
    <a class="nav-link" data-sec="technicians">Technicians</a>
    <a class="nav-link" data-sec="create-tech">‚ûï Create Technician</a>
    <a class="nav-link" data-sec="bookings">Bookings</a>
    <a class="nav-link" data-sec="bills">Bills</a>
    <a class="nav-link" data-sec="analytics">Analytics</a>
    <a class="nav-link" data-sec="heatmap">Heatmap</a>
    <a class="nav-link" data-sec="performance">Performance</a>
    <a class="nav-link" data-sec="alerts">Failed Alerts</a>
    <a class="nav-link" data-sec="audit">Audit Logs</a>
   



    <hr class="border-secondary">
    <button id="logout" class="btn btn-book w-100">LOGOUT</button>
    </div>
  </div>
  
  <div class="content-area">
    <div class="container my-1">
      <div id="carouselExample" class="carousel slide custom-carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img src="assets/ChatGPT Image Nov 18, 2025 at 12_27_41 PM.png" class="d-block w-100" alt="...">
            <div class="carousel-caption ">
              <p class="display-3 fw-bold"> <h2 id="pageTitle" class="display-1 fw-bold">Dashboard</h2></p>
             
            </div>
          </div>
        </div>
       
      </div>
    </div>
    
   
    
    <div id="content"></div>
  </div>
  <!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-white text-black">
      <div class="modal-header modalheader">
        <h5 class="modal-title" id="editModalTitle">Edit</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="editForm"></form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-book" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>
</div>


<script>
/* =====================
   AUTH CHECK
===================== */
// ADD BELOW safe()
let EDIT_CONTEXT = {
  table: "",
  id: "",
  updates: {}
};


const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
if (!token || role !== "admin") location = "index.html";

/* =====================
   API HELPER
===================== */
async function api(url, method="GET", body=null) {
  const res = await fetch(url, {
    method,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: body ? JSON.stringify(body) : null
  });
  const txt = await res.text();
  try { return JSON.parse(txt); }
  catch { return { success:false, error:"Invalid JSON" }; }
}

/* =====================
   NAV
===================== */
function setActive(el) {
  document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
  el.classList.add('active');
  pageTitle.innerText = el.innerText;
}

/* =====================
   DASHBOARD
===================== */
async function loadDashboard() {
  const d = await api('/api/admin/dashboard');

  content.innerHTML = `
    <div class="row g-3 text-white my-1">
      <div class="col-md-3"><div class="card-box">Total Bookings<h3>${d.total_bookings}</h3></div></div>
      <div class="col-md-3"><div class="card-box">Active Techs<h3>${d.active_techs}</h3></div></div>
      <div class="col-md-3"><div class="card-box">Completed<h3>${d.completed_jobs}</h3></div></div>
      <div class="col-md-3"><div class="card-box text-danger">Failed<h3>${d.failed_bookings}</h3></div></div>
    </div>

    <hr>
    <h4>Live Activity</h4>
    <div class="">
      <div id="adminLiveMap" style="height:250px;border-radius:12px;"></div>
    </div>
  `;

  await loadMapboxToken();
  initAdminMap();
  loadAdminLiveMap();
  setInterval(loadAdminLiveMap, 5000);
}

function loadCreateUser() {
  content.innerHTML = `
    <div class="cardbox text-black">
      <h4>Create New User</h4>

      <div class="mb-2">
        <label>Full Name</label>
        <input id="cu_name" class="form-control">
      </div>

      <div class="mb-2">
        <label>Phone</label>
        <input id="cu_phone" class="form-control">
      </div>

      <div class="mb-2">
        <label>Email</label>
        <input id="cu_email" type="email" class="form-control">
      </div>

      <div class="mb-3">
        <label>Password</label>
        <input id="cu_pass" type="password" class="form-control">
      </div>

      <button class="btn btn-book" onclick="createUser()">Create User</button>
    </div>
  `;
}

async function createUser() {
  const body = {
    full_name: cu_name.value,
    phone: cu_phone.value,
    email: cu_email.value,
    password: cu_pass.value
  };

  const r = await api("/api/admin/create-user", "POST", body);

  if (!r.success) {
    alert(r.error || "Failed");
    return;
  }

  alert("User created successfully");
  loadUsers();
}
function loadCreateTechnician() {
  content.innerHTML = `
    <div class="cardbox text-white">
      <h4>Create New Technician</h4>

      <div class="mb-2">
        <label>Full Name</label>
        <input id="ct_name" class="form-control">
      </div>

      <div class="mb-2">
        <label>Phone</label>
        <input id="ct_phone" class="form-control">
      </div>

      <div class="mb-2">
        <label>Email</label>
        <input id="ct_email" type="email" class="form-control">
      </div>

      <div class="mb-2">
        <label>Password</label>
        <input id="ct_pass" type="password" class="form-control">
      </div>

      <div class="mb-2">
        <label>Base Cost</label>
        <input id="ct_cost" type="number" class="form-control" value="0">
      </div>

      <div class="mb-3">
        <label>Vehicle Types (comma separated)</label>
        <input id="ct_vehicle" class="form-control" placeholder="bike,car,truck">
      </div>

      <button class="btn btn-book" onclick="createTechnician()">Create Technician</button>
    </div>
  `;
}

async function createTechnician() {
  const body = {
    full_name: ct_name.value,
    phone: ct_phone.value,
    email: ct_email.value,
    password: ct_pass.value,
    base_cost: Number(ct_cost.value),
    vehicle_types: ct_vehicle.value.split(",").map(v => v.trim())
  };

  const r = await api("/api/admin/create-serviceman", "POST", body);

  if (!r.success) {
    alert(r.error || "Failed");
    return;
  }

  alert("Technician created successfully");
  loadTechnicians();
}

/* =====================
   TABLE RENDER
===================== */
function renderTable(rows, title) {
  if (!rows || !rows.length) {
    return `<div class="card-box text-center text-muted">No data available</div>`;
  }

  const cols = Object.keys(rows[0]);

  return `
 

      <div class="table-responsive tablestyle">
        <table id="dataTable" class="table admin-table">
          <thead>
            <tr>
              ${cols.map(c => `<th>${c.replaceAll('_',' ')}</th>`).join('')}
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
               ${cols.map(c => `
<td>${formatCell(r[c], c)}</td>


`).join('')}

                <td>
  <button class="btn btn-sm btn-book"
    onclick='editRow("${title}", ${JSON.stringify(r).replace(/"/g, "&quot;")})'>
    Edit
  </button>
</td>

              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
   
  `;
}
function formatCell(val, col) {
  if (val === null || val === undefined) return "-";

  // üî• Special handling for audit log JSON
  if ((col === "old_data" || col === "new_data") && typeof val === "object") {
    return Object.entries(val)
      .map(([k, v]) => `${k}: ${v}`)
      .join("<br>");
  }

  // Generic object formatter (users, servicemen, etc.)
  if (typeof val === "object") {
    if (val.full_name) return val.full_name;
    if (val.email) return val.email;
    if (val.name) return val.name;
    if (val.id) return val.id;
    return Object.values(val).join(", ");
  }

  return val;
}


function editRow(type, row) {
  EDIT_CONTEXT = {
    table: type === "users" ? "users" : "servicemen",
    id: row.id,
    updates: {}
  };

  document.getElementById("editModalTitle").innerText =
    type === "users" ? "Edit User" : "Edit Serviceman";

  let html = "";

  if (type === "users") {
    html = `
      <div class="mb-2">
        <label>Name</label>
        <input class="form-control" value="${row.full_name || ""}"
          onchange="EDIT_CONTEXT.updates.full_name=this.value">
      </div>

      <div class="mb-2">
        <label>Phone</label>
        <input class="form-control" value="${row.phone || ""}"
          onchange="EDIT_CONTEXT.updates.phone=this.value">
      </div>

      <div class="mb-2">
        <label>Email</label>
        <input class="form-control" value="${row.email || ""}"
        onchange="EDIT_CONTEXT.updates.email=this.value">
      </div>

     <div class="mb-2">
  <label>Promote User</label>
  <button class="btn btn-danger w-100"
    onclick="promoteToAdmin('${row.id}')">
    Promote to Admin
  </button>
</div>
    `;
  }

  if (type === "servicemen") {
    html = `
      <div class="mb-2">
        <label>Name</label>
        <input class="form-control" value="${row.full_name || ""}"
          onchange="EDIT_CONTEXT.updates.full_name=this.value">
      </div>

      <div class="mb-2">
        <label>Phone</label>
        <input class="form-control" value="${row.phone || ""}"
          onchange="EDIT_CONTEXT.updates.phone=this.value">
      </div>

      <div class="mb-2">
        <label>Base Cost</label>
        <input type="number" class="form-control" value="${row.base_cost || 0}"
          onchange="EDIT_CONTEXT.updates.base_cost=this.value">
      </div>

      <div class="mb-2">
        <label>Status</label>
        <select class="form-select"
          onchange="EDIT_CONTEXT.updates.is_blocked=this.value==='true'">
          <option value="false">Active</option>
          <option value="true">Blocked</option>
        </select>
      </div>
    `;
  }

  document.getElementById("editForm").innerHTML = html;
  new bootstrap.Modal(document.getElementById("editModal")).show();
}
async function saveEdit() {
  const token = localStorage.getItem("token");

  if (!Object.keys(EDIT_CONTEXT.updates).length) {
    alert("No changes made");
    return;
  }

  const res = await fetch("/api/admin/update", {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(EDIT_CONTEXT)
  });

  const j = await res.json();
  if (!j.success) {
    alert("Update failed");
    return;
  }

  alert("Updated successfully");
  bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();

  // Reload current tab
  document.querySelector(".nav-link.active").click();
}
async function promoteToAdmin(userId) {
  if (!confirm("Promote this user to admin?")) return;

  const token = localStorage.getItem("token");

  const res = await fetch("/api/admin/promote", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ user_id: userId })
  });

  const j = await res.json();

  if (!j.success) {
    alert("Promotion failed");
    return;
  }

  alert("User promoted to admin");
  bootstrap.Modal.getInstance(
    document.getElementById("editModal")
  ).hide();
}



/* =====================
   LOADERS
===================== */

async function loadAuditLogs() {
  const r = await api("/api/admin/audit-logs");
  if (!r.success) {
    content.innerHTML = "Failed to load audit logs";
    return;
  }
  content.innerHTML = renderTable(r.logs, "audit");
}


async function loadUsers(){ const r=await api('/api/admin/users'); content.innerHTML=renderTable(r.users,'users'); }
async function loadTechnicians(){ const r=await api('/api/admin/servicemen'); content.innerHTML=renderTable(r.servicemen,'servicemen'); }
async function loadBookings(){ const r=await api('/api/admin/bookings'); content.innerHTML=renderTable(r.bookings,'bookings'); }
async function loadBills(){ const r=await api('/api/admin/bills'); content.innerHTML=renderTable(r.bills,'bills'); }

/* =====================
   HEATMAP
===================== */
async function loadHeatmap() {
  const r = await api('/api/admin/heatmap');
  content.innerHTML = `<div id="map" style="height:500px"></div>`;

  const t = await api('/api/mapbox-token');
  mapboxgl.accessToken = t.token;

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v10',
    center: [78.4867, 17.3850],
    zoom: 11
  });

  map.on('load', () => {
    map.addSource('heat', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: r.map(p => ({
          type:'Feature',
          geometry:{type:'Point', coordinates:[p.lng, p.lat]}
        }))
      }
    });
    map.addLayer({ id:'heatmap', type:'heatmap', source:'heat' });
  });
}

/* =====================
   PERFORMANCE
===================== */
async function loadPerformance() {
  const r = await api('/api/admin/performance');
  content.innerHTML = renderTable(r, 'performance');
}

/* =====================
   ALERTS
===================== */
async function loadAlerts() {
  const r = await api('/api/admin/failed-bookings');
  content.innerHTML = `
    <h4>Failed Bookings</h4>
    ${r.length
      ? r.map(b=>`<div class="card-box mb-2">#${b.id} - ${b.reason}</div>`).join('')
      : `<div class="card-box">No failed bookings üéâ</div>`
    }
  `;
}

/* =====================
   SEARCH
===================== */
function applySearch() {
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const table = document.getElementById("dataTable");
  if (!table) return;

  const trs = table.getElementsByTagName("tr");

  for (let i = 1; i < trs.length; i++) { // skip header row
    let rowText = trs[i].innerText.toLowerCase();
    trs[i].style.display = rowText.includes(filter) ? "" : "none";
  }
}

/* =====================
   MAPBOX LIVE
===================== */
let adminMap=null, adminMarkers=[], MAPBOX_TOKEN="";

async function loadMapboxToken(){
  if(MAPBOX_TOKEN) return;
  const r=await fetch('/api/mapbox-token');
  const j=await r.json();
  MAPBOX_TOKEN=j.token;
  mapboxgl.accessToken=MAPBOX_TOKEN;
}

function initAdminMap(){
  if(adminMap) return;
  adminMap=new mapboxgl.Map({
    container:"adminLiveMap",
    style:"mapbox://styles/mapbox/streets-v12",
    center:[77.5946,12.9716],
    zoom:11
  });
}

async function loadAdminLiveMap(){
  if(!adminMap) return;
  const r=await api('/api/admin/servicemen-live');
  adminMarkers.forEach(m=>m.remove());
  adminMarkers=[];
  const bounds=new mapboxgl.LngLatBounds();

  r.servicemen.forEach(sm=>{
    if(!sm.location_lat) return;
    const el=document.createElement("img");
    el.src="/assets/automobile-with-wrench.png";
    el.style.width="34px";

    const m=new mapboxgl.Marker(el)
      .setLngLat([sm.location_lng, sm.location_lat])
      .setPopup(new mapboxgl.Popup().setHTML(`
        <b>${sm.full_name}</b><br>
        ‚≠ê ${sm.rating||0}<br>
        ${sm.is_available?'üü¢ Available':'üî¥ Busy'}
      `))
      .addTo(adminMap);

    adminMarkers.push(m);
    bounds.extend([sm.location_lng, sm.location_lat]);
  });

  if(adminMarkers.length) adminMap.fitBounds(bounds,{padding:60});
}

/* =====================
   NAV ACTIONS (üî• FIXED)
===================== */
const actions = {
  dashboard: loadDashboard,
  users: loadUsers,
  technicians: loadTechnicians,
  bookings: loadBookings,
  bills: loadBills,
  heatmap: loadHeatmap,
  performance: loadPerformance,
  audit: loadAuditLogs,
  alerts: loadAlerts,
   "create-user": loadCreateUser,
  "create-tech": loadCreateTechnician
  
};

document.querySelectorAll('.nav-link').forEach(l=>{
  l.onclick=()=>{ setActive(l); actions[l.dataset.sec](); };
});

/* =====================
   LOGOUT
===================== */
logout.onclick=()=>{ localStorage.clear(); location='index.html'; };

/* =====================
   INIT
===================== */
loadDashboard();
</script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>