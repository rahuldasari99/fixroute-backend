<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>User Home</title>

    <!-- Mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <!-- Mapbox Geocoder (search box) -->
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

    <!-- Bootstrap + icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <style>
      /* Your existing small helper styles + new booking styles */
      .req-map { width:100%; height:250px; border-radius:8px; overflow:hidden; margin-top:10px; }
      .accepted-section { margin-bottom: 1rem; }
      .pending-section { margin-top: 1rem; }
      .card .small-muted { font-size:0.9rem; color:#666; }

      /* Bookings modal styles */
    .booking-card {
        border: 1px solid #e6e6e6;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 14px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;

      }
      .booking-meta { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .booking-map {flex:1; width: 100%; height: 200px; border-radius:8px; overflow:hidden; background:#f3f3f3; }
      .booking-info {flex: 1;  min-width:220px; }
      .status-badge { font-weight:600; padding:6px 10px; border-radius:12px; font-size:0.9rem; }
      .status-pending { background:#fff4e5; color:#b36b00; border:1px solid #ffd9a8; }
      .status-accepted { background:#e8f6ff; color:#0077cc; border:1px solid #cfeeff; }
      .status-onway { background:#e9ffef; color:#008b4a; border:1px solid #bff0c9; }
      .status-completed { background:#f0f0f0; color:#666; border:1px solid #ddd; }
      .small-muted { font-size:0.9rem; color:#666; }

      /* ensure maps inside modal have proper z-index for mapbox controls */
      .mapboxgl-ctrl-top-right { z-index: 1100; }
      .mapboxgl-ctrl-top-left { z-index: 1100; }

      /* geocoder container styling so it sits above the map */
      #geocoder { width: 100%; margin-bottom: 8px; }
      .geocoder-wrapper { position: relative; z-index: 1050; } /* above other modal elements */
    </style>
  </head>

  <body>
    <!-- navigation start -->
    <nav class="navbar navbar-expand-sm bg-black sticky-top py-1">
      <div class="container navedit">
        <a class="navbar-brand text-white" href="#"><span class="display-6 fw-bold">Fix</span><span class="display-5">Route</span></a>
        <button class="bi bi-list d-lg-none d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"></button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
             <li class="nav-item">
              <a class="nav-link" data-bs-toggle="modal" data-bs-target="#staticBackdrop">PROFILE</a>
            </li>

            <!-- BOOKINGS will be handled by JS to load contents -->
             <li class="nav-item">
              <a class="nav-link" id="openBookings">BOOKINGS</a>
            </li>

             <li class="nav-item">
              <a class="nav-link" id="logout">LOGOUT</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- navigation end -->

    <!-- main section start -->
    <div class="container my-4">
      <p class="fs-4 fw-normal"><span id="userNameNav"></span> facing a breakdown? We‚Äôre nearby!</p>

      <div id="carouselExample" class="carousel slide custom-carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img src="assets/ChatGPT Image Nov 18, 2025 at 12_27_41 PM.png" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block">
              <p class="display-3 fw-bold">Emergency Mechanic</p>
              <p class="fs-4">Quick help anytime, Anywhere</p>
            </div>
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>

      <!-- service cards (kept identical to your original markup) -->
      <div class="row">
        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-capitalize">FUEL DELIVERY</p>
              <p class="card-text fs-6 text-secondary">ANYWHERE ANYTIME</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="Fuel Delivery">BOOK NOW</button>
                <img src="assets/gas-station.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-uppercase">Tyre Replacement</p>
              <p class="card-text fs-6 text-secondary">On-the-Spot Help</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="Tyre Replacement">BOOK NOW</button>
                <img src="assets/racing.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-uppercase">Battery Service</p>
              <p class="card-text fs-6 text-secondary">Jump Start & Replace</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="Battery Service">BOOK NOW</button>
                <img src="assets/car-battery.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-uppercase">Mechanic</p>
              <p class="card-text fs-6 text-secondary">For Cars & Bikes</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="Mechanic">BOOK NOW</button>
                <img src="assets/automobile-with-wrench.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- second row kept -->
      <div class="row">
        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-capitalize">TOW ASSIST</p>
              <p class="card-text fs-6 text-secondary">WHEREVER YOU ARE</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="Tow Assist">BOOK NOW</button>
                <img src="assets/tow-truck.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-uppercase">TWO-WHEELER HELP</p>
              <p class="card-text fs-6 text-secondary">ON THE GO</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="Two-Wheeler Help">BOOK NOW</button>
                <img src="assets/toolbox.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-uppercase">breakdown?</p>
              <p class="card-text fs-6 text-secondary">We‚Äôll Fix It Right Away</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="Breakdown">BOOK NOW</button>
                <img src="assets/car-breakdown.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-3 col-lg-3">
          <div class="card border-0 text-center text-md-start m-4" data-aos="fade-left">
            <div class="card-body shadow-lg">
              <p class="card-text fs-5 text-uppercase">SOS Request</p>
              <p class="card-text fs-6 text-secondary">Nearby Serviceman Notified</p>
              <div class="card-btn">
                <button class="btn btn-book btn-open-service" data-service="SOS Request">BOOK NOW</button>
                <img src="assets/emergency-button.png" class="card-img" alt="">
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    <!-- main section end -->

    <!-- PROFILE modal (unchanged) -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">PROFILE</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
             <pre id="profile" class="modal-profiledetails"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- BOOKINGS modal (NEW) -->
    <div class="modal fade" id="bookingsModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header modalheader">
            <h5 class="modal-title">Your Bookings</h5>
            <button type="button" class="btn-close btncl" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="bookingMessage" class="alert alert-success d-none"></div>
            <div id="bookingList">
              <p class="text-muted">Loading bookings...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- multi-step booking modal -->
    <div class="modal fade" id="serviceModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header modalheader">
            <h5 class="modal-title">Book Service</h5>
            <button type="button" class="btn-close btncl" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div id="step1">
              <div id="carouselExample" class="carousel slide custom-carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img src="assets/pexels-maltelu-2244746.jpg" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block">
              <!-- <p class="display-3 fw-bold">Emergency Mechanic</p>
              <p class="fs-4">Quick help anytime, Anywhere</p> -->
            </div>
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
              <label class="mt-2">Service Name</label>
              <input type="text" id="serviceName" class="form-control" readonly>

              <label class="mt-3">Your Name</label>
              <input type="text" id="userNameInput" class="form-control">

              <label class="mt-3">Mobile</label>
              <input type="text" id="userMobileInput" class="form-control">

              <label class="mt-3">Your Location</label>
              <div class="d-flex gap-2 mb-2">
                <input type="text" id="userLocation" class="form-control" readonly>
                <button id="btnDetect" class="btn btn-outline-primary" type="button" title="Detect my location">‚ö≤ Detect</button>
              </div>
              <!-- Show only for Fuel Delivery -->
 <div id="fuelTypeGroup" class="mt-3" style="display:none;">
  <label>Fuel Type</label>
  <select id="fuelType" class="form-control">
    <option value="Petrol">Petrol</option>
    <option value="Diesel">Diesel</option>
  </select>
</div>

<div id="fuelLitersGroup" class="mt-3" style="display:none;">
  <label>Fuel Liters</label>
  <input type="number" id="fuelLiters" min="1" class="form-control" placeholder="Enter liters needed">
</div>


              <!-- SEARCH BOX ABOVE MAP -->
              <div class="geocoder-wrapper">
                <div id="geocoder"></div>
              </div>

              <!-- MAP -->
              <div id="map" style="height:300px; background:#eee; border-radius:10px; margin-top:8px;"></div>

              <!-- SAVE + RESET BUTTONS -->
              <div class="d-flex gap-2 mt-3">
                <button class="btn btn-book btn-sm" id="btnSaveLocation">Save This Location</button>
                <button class="btn btn-cancel btn-sm" id="btnResetLocation">Reset</button>
              </div>
              <small class="text-muted d-block mt-2">
                You can detect, search, click on the map or drag the pin. Press Save to apply this location for booking.
              </small>
            </div>

            <div id="step2" style="display:none;">
              <h4 class="mb-3 text-center">Servicemen Near You</h4>
              <div id="techMap" style="height:250px; border-radius:12px; margin-bottom:15px;"></div>
              <div id="techList" class="mx-4"></div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-book" id="btnSelectTech">Select Technician</button>
          </div>
        </div>
      </div>
    </div>



    <footer class="footer p-4 border-top footer-txt bg-black">
      <div class="container">
        <!-- footer-navigation start -->
        <div class="row">
          <!-- col-1 -->
          <div class="col-sm-12 col-md-3 col-lg-3">
            <!-- brand-information -->
             <a class="navbar-brand text-white" href="#"
          ><span class="display-6 fw-bold">Fix</span><span class="display-5">Route</span></a
        >

            <!-- brand-title -->
            <p class="text-lead text-capitalize mb-2">
              FixRoute Analytics helps you understand real-time service demand, track technician performance, and identify high-request zones. With data-driven insights, your team can respond faster, allocate technicians better, and deliver a smoother on-road assistance experience.
            </p>
            <!-- social media icons -->
            <div class="footer-social-icons my-3">
              <i class="fs-4 p-2 border rounded bi bi-whatsapp"></i>
              <i class="fs-4 p-2 border rounded bi bi-facebook"></i>
              <i class="fs-4 p-2 border rounded bi bi-instagram"></i>
              <i class="fs-4 p-2 border rounded bi bi-linkedin"></i>
            </div>
          </div>
          <!-- col-2 -->
          <div class="col-sm-12 col-md-3 col-lg-3">
            <h4 class="fw-bold">Quick Links</h4>
            <ul class="list-unstyled">
              <li class="p-1"><a href="index--1.html">Home</a></li>
              <li class="p-1"><a href="index.html">Services</a></li>
            
            
              <li class="p-1"><a href="contact.html">Contact</a></li>
            </ul>
          </div>
          <!-- col-3 -->
          <div class="col-sm-12 col-md-3 col-lg-3">
            <h4 class="fw-bold">Services</h4>
            <ul class="list-unstyled">
              <li class="p-1">Insights & Reports</li>
              <li class="p-1">Recommendations</li>
              <li class="p-1">usage dashboard</li>
              <li class="p-1">Visualizations</li>
            </ul>
          </div>
          <!-- col-4 -->
          <div class="col-sm-12 col-md-3 col-lg-3">
            <h4 class="fw-bold">Get to know us</h4>
            <ul class="list-unstyled">
              <li class="p-1">About Fixroute</li>
              <li class="p-1">Terms&Conditions</li>
              <li class="p-1">Privacy Policy</li>

              <li class="p-1">Careers</li>
            </ul>
          </div>
        </div>
        <hr class="border-top  border-2" />
        <!-- footer-navigation end -->
        <div class="text-center">
          <p class="fs-6 fw-bold">
            Copyright &copy; 2025 fixroute. All Right Reserved
          </p>
        </div>
      </div>
    </footer>
    <!-- modal end -->

    <!-- SCRIPTS -->
     <script>
      /*****************************************************************
       * Unified script:
       * - Keeps original behavior
       * - Adds: Detect button, Search box (Mapbox Geocoder), draggable marker,
       *   Save This Location and Reset
       * - Option A: location is stored locally (SELECTED_LAT/LNG) and sent
       *   to /api/book-service when booking.
       *****************************************************************/

      // small helper
      const safe = (v, def='') => (v === null || v === undefined) ? def : v;

      // Mapbox token holder
      let MAPBOX_TOKEN = "";
      async function loadMapboxToken() {
        if (MAPBOX_TOKEN) return MAPBOX_TOKEN;
        try {
          const r = await fetch('/api/mapbox-token');
          const j = await r.json();
          MAPBOX_TOKEN = j.token || '';
          return MAPBOX_TOKEN;
        } catch (e) {
          console.error('mapbox token load err', e);
          return '';
        }
      }
      loadMapboxToken();

      /* -----------------------------
         GLOBAL STATE (Option A - local storage until booking)
      ------------------------------ */
      let currentMap = null;
      let currentMarker = null;
      let geocoderControl = null;

      let SELECTED_LAT = null;
      let SELECTED_LNG = null;
      let USER_PICKED_LOCATION = false; // tracks whether user saved/picked a manual location

      /* -----------------------------
         LOAD USER PROFILE (Original)
      ------------------------------ */
      async function load() {
        const t = localStorage.getItem("token");
        if (!t) return (location.href = "index.html");

        const r = await fetch("/api/me", {
          headers: { Authorization: "Bearer " + t },
        });

        if (!r.ok) {
          localStorage.clear();
          return (location.href = "index.html");
        }

        const j = await r.json();

        // top nav name (note: modal input ids were renamed to avoid duplicates)
        const navNameEl = document.querySelector('#userNameNav');
        if (navNameEl) navNameEl.textContent = j.profile.full_name || 'User';

        document.getElementById("profile").innerHTML = `
          <p><strong>Name:</strong> ${safe(j.profile.full_name)}</p>
          <p><strong>Email:</strong> ${safe(j.profile.email)}</p>
          <p><strong>Phone:</strong> ${safe(j.profile.phone || "Not Added")}</p>
        `;

        // prefill modal fields if present
        const nameInput = document.getElementById('userNameInput');
        const phoneInput = document.getElementById('userMobileInput');
        if (nameInput) nameInput.value = j.profile.full_name || '';
        if (phoneInput) phoneInput.value = j.profile.phone || '';
      }

      document.getElementById("logout").addEventListener("click", () => {
        localStorage.clear();
        location.href = "index.html";
      });

      load();

      /* -----------------------------
         Helper: update input + selected variables
      ------------------------------ */
      function setSelectedLocation(lat, lng) {
        SELECTED_LAT = Number(lat);
        SELECTED_LNG = Number(lng);
        USER_PICKED_LOCATION = true;
        const locEl = document.getElementById('userLocation');
        if (locEl) locEl.value = `${SELECTED_LAT}, ${SELECTED_LNG}`;
      }

      /* -----------------------------
         Initialize modal map (used when modal opens)
         - places draggable marker
         - attaches geocoder (search box) above map
         - supports click-to-move-pin and drag
      ------------------------------ */
      async function initModalMap(initialLat, initialLng) {
        await loadMapboxToken();
        mapboxgl.accessToken = MAPBOX_TOKEN;

        const fallback = { lat: 12.9716, lon: 77.5946 };

        let lat = Number(initialLat);
        let lng = Number(initialLng);
        if (!isFinite(lat) || !isFinite(lng)) {
          lat = fallback.lat;
          lng = fallback.lon;
        }

        // If user has previously picked a manual location, prefer that (don't overwrite)
        if (USER_PICKED_LOCATION && SELECTED_LAT != null && SELECTED_LNG != null) {
          lat = SELECTED_LAT;
          lng = SELECTED_LNG;
        }

        // Set current selected (will be saved on Save click)
        const locEl = document.getElementById('userLocation');
        if (!USER_PICKED_LOCATION) {
          // only update the input if user hasn't explicitly picked a location
          if (locEl) locEl.value = `${lat}, ${lng}`;
        } else {
          // ensure input shows saved coords
          if (locEl && SELECTED_LAT != null && SELECTED_LNG != null) locEl.value = `${SELECTED_LAT}, ${SELECTED_LNG}`;
        }

        // Clear previous map
        const mapContainer = document.getElementById('map');
        mapContainer.innerHTML = '';
        if (currentMap) {
          try { currentMap.remove(); } catch(e) {}
          currentMap = null;
          currentMarker = null;
        }

        // Create the map
        currentMap = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [lng, lat],
          zoom: 14
        });

        // Add nav
        currentMap.addControl(new mapboxgl.NavigationControl(), 'top-left');

        // Create draggable marker
        currentMarker = new mapboxgl.Marker({ color: 'red', draggable: true })
          .setLngLat([lng, lat])
          .addTo(currentMap);

        currentMarker.on('dragend', () => {
          const ll = currentMarker.getLngLat();
          setSelectedLocation(ll.lat, ll.lng);
        });

        // Click map to move marker
        currentMap.on('click', (e) => {
          const lng2 = e.lngLat.lng;
          const lat2 = e.lngLat.lat;
          if (currentMarker) currentMarker.setLngLat([lng2, lat2]);
          setSelectedLocation(lat2, lng2);
        });

        // Attach geocoder into #geocoder (make sure plugin loaded)
        try {
          if (typeof MapboxGeocoder === 'undefined') {
            console.warn('MapboxGeocoder not available ‚Äî ensure plugin script loaded');
          } else {
            // Remove old control if present
            if (geocoderControl && currentMap) {
              try { currentMap.removeControl(geocoderControl); } catch(e){}
              geocoderControl = null;
              document.getElementById('geocoder').innerHTML = '';
            }

            geocoderControl = new MapboxGeocoder({
              accessToken: MAPBOX_TOKEN,
              mapboxgl: mapboxgl,
              marker: false,
              placeholder: 'Search location',
              proximity: { longitude: lng, latitude: lat }
            });

            // We want the geocoder DOM inside our #geocoder
            const geocoderElem = geocoderControl.onAdd(currentMap);
            const wrapper = document.getElementById('geocoder');
            wrapper.innerHTML = '';
            wrapper.appendChild(geocoderElem);

            geocoderControl.on('result', (ev) => {
              if (!ev || !ev.result || !ev.result.center) return;
              const [lonR, latR] = ev.result.center;
              if (currentMarker) currentMarker.setLngLat([lonR, latR]);
              currentMap.flyTo({ center: [lonR, latR], zoom: 15 });
              setSelectedLocation(latR, lonR);
            });

          }
        } catch (e) {
          console.error('geocoder init error', e);
        }
      }

      /* -----------------------------
         Buttons: Detect, Save, Reset
      ------------------------------ */
      // Detect button: updates marker to current geolocation
      document.getElementById('btnDetect').addEventListener('click', () => {
        if (!navigator.geolocation) return alert('Geolocation not supported by your browser');
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          if (!currentMap) {
            // init map at detected location
            initModalMap(lat, lon);
          } else {
            currentMap.flyTo({ center: [lon, lat], zoom: 14 });
            if (currentMarker) currentMarker.setLngLat([lon, lat]);
            setSelectedLocation(lat, lon);
          }
        }, err => {
          console.warn('geolocation error', err);
          alert('Could not detect location');
        }, { enableHighAccuracy: true, maximumAge: 60000 });
      });

      // Save location: stores into SELECTED_LAT/LNG and updates input (that's already done by setSelectedLocation)
      document.getElementById('btnSaveLocation').addEventListener('click', () => {
        if (SELECTED_LAT == null || SELECTED_LNG == null) return alert('No location selected');
        // visual feedback
        const btn = document.getElementById('btnSaveLocation');
        btn.textContent = 'Saved ‚úì';
        // ensure flag is set
        USER_PICKED_LOCATION = true;
        setTimeout(() => btn.textContent = 'üíæ Save This Location', 1200);
        // (Under Option A we don't call the server here. Booking will include saved coords.)
      });

      // Reset button: reset to geolocation if allowed, else to default center
      document.getElementById('btnResetLocation').addEventListener('click', () => {
        // clear saved selection
        USER_PICKED_LOCATION = false;
        SELECTED_LAT = null;
        SELECTED_LNG = null;
        const locEl = document.getElementById('userLocation');
        if (locEl) locEl.value = '';

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            initModalMap(pos.coords.latitude, pos.coords.longitude);
          }, () => {
            initModalMap(null, null);
          });
        } else {
          initModalMap(null, null);
        }
      });

      /* -----------------------------
         BOOK NOW flow ‚Äî open modal and init map
      ------------------------------ */
     document.addEventListener('click', async function (e) {
    const btn = e.target.closest('.btn-open-service');
    if (!btn) return;

    const service = btn.getAttribute('data-service') || 'General Service';
    document.getElementById('serviceName').value = service;

    /* -------------------------------------------------
       FIX: Show fuel liters/type immediately first time
    -------------------------------------------------- */
    if (service === "Fuel Delivery") {
        document.getElementById("fuelLitersGroup").style.display = "block";
        document.getElementById("fuelTypeGroup").style.display = "block";
    } else {
        document.getElementById("fuelLitersGroup").style.display = "none";
        document.getElementById("fuelTypeGroup").style.display = "none";
    }

    // fetch user profile to prefill (your original code)
    const token = localStorage.getItem('token');
    if (token) {
      try {
        const r = await fetch('/api/me', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (r.ok) {
          const j = await r.json();
          const nameInput = document.getElementById('userNameInput');
          const phoneInput = document.getElementById('userMobileInput');
          if (nameInput) nameInput.value = j.profile.full_name || '';
          if (phoneInput) phoneInput.value = j.profile.phone || '';
          const navNameEl = document.getElementById('userNameNav');
          if (navNameEl) navNameEl.textContent = j.profile.full_name || 'User';
        }
      } catch (err) {
        console.warn('could not load /api/me', err);
      }
    }

    // prefer saved location
    if (USER_PICKED_LOCATION && SELECTED_LAT != null && SELECTED_LNG != null) {
        initModalMap(SELECTED_LAT, SELECTED_LNG);
    } else {
        // try geolocation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                initModalMap(pos.coords.latitude, pos.coords.longitude);
            }, () => {
                initModalMap(null, null);
            }, { enableHighAccuracy: true, maximumAge: 60000 });
        } else {
            initModalMap(null, null);
        }
    }

    // show modal (original)
    const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
    modal.show();
});


      /* -----------------------------
         STEP 2 ‚Äî CALL BACKEND AND SHOW TECHNICIANS
         (requires that user saved or selected location)
      ------------------------------ */
      let techMap = null;
let techMarkers = [];
let userMarker = null;

/* -----------------------------
   Create Technician Map
------------------------------ */
function initTechMap(lat, lng) {
  if (techMap) {
    try { techMap.remove(); } catch (e) {}
    techMap = null;
  }

  techMap = new mapboxgl.Map({
    container: "techMap",
    style: "mapbox://styles/mapbox/streets-v11",
    center: [lng, lat],
    zoom: 12
  });

  techMap.on("load", () => {
    // User marker (blue)
    userMarker = new mapboxgl.Marker({ color: "blue" })
      .setLngLat([lng, lat])
      .setPopup(new mapboxgl.Popup().setHTML("<b>Your Location</b>"))
      .addTo(techMap);
  });
}

/* -----------------------------
   LOAD TECHNICIANS AFTER STEP 1
------------------------------ */
document.getElementById("btnSelectTech").addEventListener("click", async () => {
  if (SELECTED_LAT == null || SELECTED_LNG == null) {
    return alert("Please detect or pick a location and press Save.");
  }

  const service = document.getElementById("serviceName").value;
  const token = localStorage.getItem("token");
  const container = document.getElementById("techList");
  container.innerHTML = '<div class="text-center p-3">Loading technicians...</div>';

  try {
    const resp = await fetch("/api/recommend-servicemen", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({
        service_type: service,
        lat: SELECTED_LAT,
        lng: SELECTED_LNG
      })
    });

    const json = await resp.json();
    const results = json.results || [];
    container.innerHTML = "";

    /* -----------------------------
       Show NO technicians
    ------------------------------ */
    if (results.length === 0) {
      container.innerHTML = `<p class="text-muted">No technicians found near you.</p>`;
      return;
    }

    /* -----------------------------
       Initialize Map
    ------------------------------ */
    initTechMap(SELECTED_LAT, SELECTED_LNG);

    /* -----------------------------
       CLEAR OLD MARKERS
    ------------------------------ */
    techMarkers.forEach(m => m.remove());
    techMarkers = [];

    const bounds = new mapboxgl.LngLatBounds();
    bounds.extend([SELECTED_LNG, SELECTED_LAT]); // user location

    /* -----------------------------
       Build Technician Cards + Map Markers
    ------------------------------ */
    results.forEach(t => {
console.log("Technician:", t);

      // Add card
      container.innerHTML += `
        <div class="border rounded p-3 my-2 shadow-sm servicemen-info d-flex justify-content-between align-items-center">
          <div class="tech-info">
            <h5>${escapeHtml(t.full_name)} (‚≠ê ${escapeHtml(String(t.rating || 0))})</h5>
            <p>Distance: ${Number(t.distance_km || 0).toFixed(2)} km</p>
            <p>ETA: ${Math.round(t.eta_predicted || 0)} mins</p>
            <p>Base Cost: ‚Çπ${escapeHtml(String(t.base_cost || 0))}</p>

            <button class="btn btn-book select-tech"
                    data-id="${t.id}"
                    data-eta="${t.eta_predicted}"
                    data-name="${escapeHtml(t.full_name)}">
              Select
            </button>
          </div>
          <div class="tech-img text-end">
            <img src="assets/mechanic.png" style="width:80px; height:80px;">
          </div>
        </div>
      `;

      // Map markers
      // Technician Map Marker (Correct DB Fields)
const techLat = t.location_lat;
const techLng = t.location_lng;

if (techLat && techLng) {
  const el = document.createElement("img");
  el.src = "assets/automobile-with-wrench.png";   // your wrench icon
  el.className = "wrench-marker";

  const marker = new mapboxgl.Marker(el)
    .setLngLat([techLng, techLat])
    .setPopup(
      new mapboxgl.Popup().setHTML(`
        <b>${t.full_name}</b><br>
        ‚≠ê ${t.rating || 0}<br>
         basecost: <b>${t.base_cost}</b><br>

        ETA: ${Math.round(t.eta_predicted)} mins
      `)
    )
    .addTo(techMap);

  techMarkers.push(marker);
  bounds.extend([techLng, techLat]);
}

    });

    /* -----------------------------
       Auto Zoom to fit all markers
    ------------------------------ */
    techMap.fitBounds(bounds, { padding: 40 });

    /* -----------------------------
       Switch UI from Step 1 ‚Üí Step 2
    ------------------------------ */
    document.getElementById("step1").style.display = "none";
    document.getElementById("step2").style.display = "block";
    document.getElementById("btnSelectTech").style.display = "none";
    document.querySelector("#serviceModal .modal-title").innerText = "Select Technician";
    setTimeout(() => {
    if (techMap) techMap.resize();
}, 300);


  } catch (err) {
    console.error("recommend servicemen err", err);
    container.innerHTML = '<p class="text-danger">Error loading technicians.</p>';
  }
});

/* -----------------------------
   SELECT TECHNICIAN ‚Üí BOOK
------------------------------ */
document.getElementById("techList").addEventListener("click", async (e) => {
  const btn = e.target.closest(".select-tech");
  if (!btn) return;

  const serviceman_id = btn.dataset.id;
  const eta = Number(btn.dataset.eta) || 0;
  const name = btn.dataset.name;
  const service = document.getElementById("serviceName").value;

  if (SELECTED_LAT == null || SELECTED_LNG == null) {
    showMessage("Location missing ‚Äî please Save Location.", "danger");
    return;
  }

  const token = localStorage.getItem("token");

  // ‚≠ê Fuel delivery inputs
  const liters = document.getElementById("fuelLiters")?.value || null;
  const fuelType = document.getElementById("fuelType")?.value || null;

  try {
    const resp = await fetch("/api/book-service", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({
        serviceman_id,
        service_type: service,
        lat: SELECTED_LAT,
        lng: SELECTED_LNG,
        eta_predicted: eta,
        fuel_liters: liters,      // ‚≠ê Added
        fuel_type: fuelType       // ‚≠ê Added
      })
    });

    const json = await resp.json();
    if (!json.success) {
      showMessage("Booking failed: " + json.error, "danger");
      return;
    }

    showMessage(`Booking Successful with ${name}!`, "success");

    const modalEl = document.getElementById("serviceModal");
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    modalInstance.hide();

    const bookingsModalEl = document.getElementById("bookingsModal");
    let bookingsModal = bootstrap.Modal.getInstance(bookingsModalEl);
    if (!bookingsModal) bookingsModal = new bootstrap.Modal(bookingsModalEl);

    loadBookings();
    bookingsModal.show();

  } catch (err) {
    console.error("book-service error", err);
    showMessage("Error booking service.", "danger");
  }
});
function showMessage(text, type = "success") {
  const msg = document.getElementById("bookingMessage");
  if (!msg) return;

  msg.className = "alert alert-" + type;
  msg.innerHTML = text;   // <-- allows badges and HTML
  msg.classList.remove("d-none");

  setTimeout(() => {
    msg.classList.add("d-none");
  }, 3000);
}

      /* -----------------------------
         Reset modal DOM when hidden (user closes manually)
      ------------------------------ */
      document.getElementById('serviceModal').addEventListener('hidden.bs.modal', function () {
        // restore step1 UI
        try {
          document.getElementById('step1').style.display = 'block';
          document.getElementById('step2').style.display = 'none';
          document.getElementById('btnSelectTech').style.display = 'block';
          document.querySelector('#serviceModal .modal-title').innerText = 'Book Service';
          document.getElementById('techList').innerHTML = '';
        } catch (e) {}

        if (currentMap) {
          try { currentMap.remove(); } catch(e) {}
          currentMap = null;
          currentMarker = null;
        }
        // remove any orphan backdrops
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
      });

      /* -----------------------------
         --- Bookings modal & live-tracking (unchanged logic, kept mostly same)
         (I kept your original booking map/poll logic but ensured map creation uses MAPBOX_TOKEN)
      ------------------------------ */

      const POLL_INTERVAL = 2000; // ms
      const bookingMaps = {};     // { bookingId: { map, userMarker, techMarker, intervalId } }

      function statusBadge(status) {
        const s = (status || '').toLowerCase();
        if (s === 'pending') return `<span class="status-badge status-pending">Pending</span>`;
        if (s === 'accepted') return `<span class="status-badge status-accepted">Accepted</span>`;
        if (s === 'on_the_way' || s === 'onway' || s === 'coming' || s === 'on the way') return `<span class="status-badge status-onway">On the way</span>`;
        if (s === 'completed') return `<span class="status-badge status-completed">Completed</span>`;
        return `<span class="status-badge status-pending">${escapeHtml(status || 'Unknown')}</span>`;
      }

      // openBookings click handler
      document.getElementById('openBookings').addEventListener('click', async () => {
        const modalEl = document.getElementById('bookingsModal');
        const modal = new bootstrap.Modal(modalEl);

        await loadBookings(); // loads user bookings and initializes maps
        modal.show();
      });

      // fetch user bookings
      async function loadBookings() {
        const token = localStorage.getItem('token');
        const container = document.getElementById('bookingList');
        if (!token) { container.innerHTML = '<p class="text-muted">Not logged in.</p>'; return; }

        try {
          const r = await fetch('/api/user/bookings', { headers: { Authorization: "Bearer " + token }});
          if (!r.ok) { container.innerHTML = '<p class="text-muted">Failed to load bookings.</p>'; return; }
          const j = await r.json();
          const bookings = j.bookings || [];

          // cleanup old maps/pollers
          for (const id in bookingMaps) {
            try { if (bookingMaps[id].intervalId) clearInterval(bookingMaps[id].intervalId); } catch(e){}
            try { if (bookingMaps[id].map) bookingMaps[id].map.remove(); } catch(e){}
          }
          for (const k in bookingMaps) delete bookingMaps[k];

          if (!bookings.length) { container.innerHTML = '<p class="text-muted">No bookings yet.</p>'; return; }

          container.innerHTML = '';
          for (const b of bookings) {
            const id = b.id;
            const serv = b.serviceman || null;
            const servName = serv ? serv.full_name : (b.serviceman_name || 'Not Assigned');
             const servNum = serv ? serv.phone : (b.serviceman_phone || 'Not Assigned');

            const wrapper = document.createElement('div');
            wrapper.className = 'booking-card d-flex gap-3 align-items-start';
            wrapper.innerHTML = `
              <div class="booking-info">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">${escapeHtml(b.service_type || 'Service')}</h6>
                    <div class="small-muted">Booking ID: ${escapeHtml(b.id)}</div>
                  </div>
                  <div>${statusBadge(b.status)}</div>
                </div>

                <div class="mt-2">
                  <div><strong>Serviceman:</strong> ${escapeHtml(servName)}</div>
                   <div><strong>Phone:</strong> ${escapeHtml(servNum)}</div>
                  <div class="small-muted"><strong>ETA:</strong> ${escapeHtml(String(Math.round(b.eta_predicted || 0)))} mins</div>
                  <div class="small-muted"><strong>Booked at:</strong> ${escapeHtml(new Date(b.created_at).toLocaleString())}</div>
                  <div class="small-muted"><strong>Address (coords):</strong> ${escapeHtml(String(b.lat) + ', ' + String(b.lng))}</div>
                </div>
                
              </div>

              <div style="min-width:220px;">
                <div id="booking-map-${id}" class="booking-map"></div>
              </div>
            `;
            container.appendChild(wrapper);

            // init booking map
            initBookingMap(b).catch(err => {
              console.error('initBookingMap error', err);
              const el = document.getElementById('booking-map-' + id);
              if (el) el.innerHTML = '<p class="text-muted small">Map failed to initialize.</p>';
            });
            
            attachBillUIForBooking(b, wrapper);
          
          }
        } catch (e) {
          console.error('loadBookings err', e);
          document.getElementById('bookingList').innerHTML = '<p class="text-muted">Failed to load bookings.</p>';
        }
        // Attach Billing UI (new)


       
}

      

      // initialize map for a booking and start polling
      async function initBookingMap(booking) {
        if (!MAPBOX_TOKEN) await loadMapboxToken();
        mapboxgl.accessToken = MAPBOX_TOKEN;

        const id = booking.id;
        const containerId = 'booking-map-' + id;
        const el = document.getElementById(containerId);
        if (!el) return;
        el.innerHTML = '';

        const userLat = Number(booking.lat);
        const userLng = Number(booking.lng);
        let techLat = booking.live_lat ?? (booking.serviceman ? booking.serviceman.location_lat : null) ?? booking.serviceman_lat ?? null;
        let techLng = booking.live_lng ?? (booking.serviceman ? booking.serviceman.location_lng : null) ?? booking.serviceman_lng ?? null;

        const center = (!isNaN(techLat) && !isNaN(techLng)) ? [Number(techLng), Number(techLat)] :
                       (!isNaN(userLat) && !isNaN(userLng)) ? [Number(userLng), Number(userLat)] : [0,0];

        const m = new mapboxgl.Map({
          container: containerId,
          style: "mapbox://styles/mapbox/streets-v12",
          center,
          zoom: 12,
          interactive: false
        });

        // markers
        let userMarker = null;
        let techMarker = null;
        if (!isNaN(userLat) && !isNaN(userLng)) {
          userMarker = new mapboxgl.Marker({ color: '#0066ff' }).setLngLat([userLng, userLat]).addTo(m);
        }
        if (!isNaN(techLat) && !isNaN(techLng)) {
          techMarker = new mapboxgl.Marker({ color: '#00b050' }).setLngLat([techLng, techLat]).addTo(m);
        }

        bookingMaps[id] = { map: m, userMarker, techMarker, intervalId: null };

        const updateRoute = async (mapObj, fromLng, fromLat, toLng, toLat) => {
          if (!mapObj || fromLng == null || fromLat == null || toLng == null || toLat == null) return;
          try {
            const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${fromLng},${fromLat};${toLng},${toLat}?geometries=geojson&overview=full&access_token=${MAPBOX_TOKEN}`;
            const dr = await fetch(directionsUrl);
            if (!dr.ok) return;
            const dj = await dr.json();
            if (!dj.routes || !dj.routes[0] || !dj.routes[0].geometry) return;
            const geo = dj.routes[0].geometry;

            const srcId = 'route-src-' + id;
            const layerId = 'route-layer-' + id;
            if (mapObj.getSource && mapObj.getSource(srcId)) {
              try { mapObj.getSource(srcId).setData({ type: 'Feature', geometry: geo }); } catch (e) { }
            } else {
              try {
                mapObj.addSource(srcId, { type: 'geojson', data: { type: 'Feature', geometry: geo } });
                mapObj.addLayer({
                  id: layerId,
                  type: 'line',
                  source: srcId,
                  layout: { 'line-join': 'round', 'line-cap': 'round' },
                  paint: { 'line-color': '#007AFF', 'line-width': 3 }
                });
              } catch (e) {}
            }

            // fit bounds
            try {
              const coords = geo.coordinates;
              const lats = coords.map(c => c[1]);
              const lngs = coords.map(c => c[0]);
              const minLat = Math.min(...lats);
              const maxLat = Math.max(...lats);
              const minLng = Math.min(...lngs);
              const maxLng = Math.max(...lngs);
              mapObj.fitBounds([[minLng, minLat], [maxLng, maxLat]], { padding: 20, maxZoom: 15 });
            } catch (e) {}
          } catch (e) {
            // ignore
          }
        };

        const poller = async () => {
          try {
            const r = await fetch('/api/live-tracking/' + encodeURIComponent(id));
            if (!r.ok) return;
            const j = await r.json();
            if (!j.success) return;

            const uLat = (j.user_lat !== null && j.user_lat !== undefined) ? Number(j.user_lat) : null;
            const uLng = (j.user_lng !== null && j.user_lng !== undefined) ? Number(j.user_lng) : null;
            const tLat = (j.tech_lat !== null && j.tech_lat !== undefined) ? Number(j.tech_lat) : null;
            const tLng = (j.tech_lng !== null && j.tech_lng !== undefined) ? Number(j.tech_lng) : null;
            const status = j.status;

            if (tLat != null && tLng != null) {
              if (!bookingMaps[id].techMarker) bookingMaps[id].techMarker = new mapboxgl.Marker({ color: '#00b050' }).setLngLat([tLng, tLat]).addTo(m);
              else bookingMaps[id].techMarker.setLngLat([tLng, tLat]);
            }

            if (uLat != null && uLng != null) {
              if (!bookingMaps[id].userMarker) bookingMaps[id].userMarker = new mapboxgl.Marker({ color: '#0066ff' }).setLngLat([uLng, uLat]).addTo(m);
              else bookingMaps[id].userMarker.setLngLat([uLng, uLat]);
            }

            if (tLat != null && tLng != null && uLat != null && uLng != null) {
              await updateRoute(m, tLng, tLat, uLng, uLat);
            }

            // update status badge
            try {
              const card = document.getElementById('booking-map-' + id).closest('.booking-card');
              if (card) {
                const badgeHolder = card.querySelector('.status-badge');
                if (badgeHolder) badgeHolder.outerHTML = statusBadge(status);
              }
            } catch (e) {}

          } catch (e) {}
        };

        // initial poll + interval
        await poller();
        const iid = setInterval(poller, POLL_INTERVAL);
        bookingMaps[id].intervalId = iid;
      }

      // small html escape
      function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      window.openInGoogleMaps = function(servicemanLat, servicemanLng, userLat, userLng) {
        const smLat = servicemanLat || '';
        const smLng = servicemanLng || '';
        const uLat = userLat || '';
        const uLng = userLng || '';

        let url = '';
        if (smLat && smLng) {
          url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(smLat + ',' + smLng)}&destination=${encodeURIComponent(uLat + ',' + uLng)}&travelmode=driving`;
        } else {
          url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(uLat + ',' + uLng)}`;
        }
        window.open(url, '_blank');
      };
      /* ======================================================
     BILL UI + PAYMENT SYSTEM (Add at very bottom)
====================================================== */

function billAmount(bill) {
  return (bill && (bill.amount ?? bill.total_price ?? bill.total ?? bill.price)) || 0;
}

async function attachBillUIForBooking(booking, wrapper) {
  try {
    const token = localStorage.getItem('token');
    if (!token) return;

    const res = await fetch('/api/bills?booking_id=' + encodeURIComponent(booking.id), {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) return;

    const j = await res.json();
    const bills = j.bills || j.data || [];
    if (!bills.length) return;

    const bill = bills[0];

    // Safe numeric fields (fallback to 0)
    const aiPrice = Number(bill.ai_price ?? 0);
    const sparePrice = Number(bill.spare_part_price ?? 0);
    // If bill.amount exists use it, otherwise sum parts as fallback
    const totalAmount = Number(bill.amount ?? (aiPrice + sparePrice));
    const displayAmount = totalAmount.toFixed(2);

    const status = (bill.status || bill.payment_status || "pending").toLowerCase();
    const billId = bill.id;
    const description = bill.description || "";
    // optionally show serviceman name if included on bill
    const servicemanName = (bill.serviceman_name || (bill.serviceman ? bill.serviceman.full_name : null) || "");

    // helper: format currency
    function formatINR(v) {
      if (isNaN(v)) v = 0;
      // basic formatting with two decimals and comma thousands
      return v.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // build detailed bill HTML
    const billHtml = document.createElement("div");
    billHtml.className = "mt-3 p-3 border rounded bg-white billui";

    billHtml.innerHTML = `
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <h5 class="mb-1">Invoice</h5>
          <div class="small text-muted">Booking: ${escapeHtml(String(booking.id || ''))}</div>
          ${servicemanName ? `<div class="small text-muted">Serviceman: ${escapeHtml(servicemanName)}</div>` : ''}
        </div>
        <div class="text-end">
          <div class="small text-muted">Status</div>
          <div class="fw-bold ${status === 'paid' ? 'text-success' : 'text-warning'}">${escapeHtml(status)}</div>
           
        </div>
        
      </div>

      <table class="table table-sm mb-2">
        <tbody>
          <tr>
            <td><strong>Price</strong></td>
            <td class="text-end">‚Çπ${formatINR(aiPrice)}</td>
          </tr>
          <tr>
            <td><strong>Spare Part Price</strong></td>
            <td class="text-end">‚Çπ${formatINR(sparePrice)}</td>
          </tr>
          <tr>
            <td><strong>Other / Fees</strong></td>
            <td class="text-end">‚Çπ${formatINR(Number(bill.other_fees ?? 0))}</td>
          </tr>
          <tr>
            <td><strong>Total</strong></td>
            <td class="text-end fw-bold">‚Çπ${formatINR(totalAmount)}</td>
          </tr>
        </tbody>
      </table>

      ${description ? `<div class="mb-2"><strong>Notes:</strong> ${escapeHtml(description)}</div>` : ''}

      <div id="bill-ui-${billId}" class="mt-1"></div>
    `;

    wrapper.appendChild(billHtml);

    const act = document.getElementById("bill-ui-" + billId);

    if (!act) return;

    if (status === "paid") {
      act.innerHTML = `<span class='text-success'>Paid</span>
       <button class="btn btn-book btn-sm mx-3" onclick="downloadBill('${billId}')">
          Download
        </button>`;
      return;
    }

    // preserve existing payBill signature (billId, amt)
    act.innerHTML = `
      <div class="d-flex gap-2">
        <button class="btn btn-book btn-sm" onclick="payBill('${billId}', '${totalAmount}')">
          Pay Bill ‚Äî ‚Çπ${formatINR(totalAmount)}
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="downloadBill('${billId}')">
          Download
        </button>
      </div>
    `;

  } catch (err) {
    console.error("Bill UI error:", err);
  }
}



/* --- Payment Function --- */
async function payBill(billId) {
  const token = localStorage.getItem("token");

  const res = await fetch("/api/create-payment", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ bill_id: billId })
  });

  const data = await res.json();
  if (!data.success) {
    console.error("Create Payment Error:", data);
    return alert("Error: " + data.error);
  }

  const options = {
    key: data.key,
    amount: data.amount,
    currency: "INR",
    order_id: data.order_id,

    handler: async function (response) {
      const verify = await fetch("/api/verify-payment", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          bill_id: billId,
          razorpay_payment_id: response.razorpay_payment_id,
          razorpay_order_id: response.razorpay_order_id,
          razorpay_signature: response.razorpay_signature
        })
      });

      const v = await verify.json();
      if (v.success) {
        alert("Payment Successful!");
        loadBookings();
      } else {
        alert("Verification Failed!");
      }
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
}

async function downloadBill(billId) {
  try {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("You must be logged in to download the bill.");
      return;
    }

    // Fetch the specific bill by ID
    const res = await fetch(`/api/bills?id=${billId}`, {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) {
      alert("Unable to fetch the bill for download.");
      return;
    }

    const data = await res.json();
    const bill = data.bill || data || null;

    if (!bill) {
      alert("Bill not found.");
      return;
    }

    // Extract bill values safely
    const aiPrice = Number(bill.ai_price ?? 0);
    const sparePrice = Number(bill.spare_part_price ?? 0);
    const otherFees = Number(bill.other_fees ?? 0);
    const extraCharges = Number(bill.extra_charges ?? 0);
    const basePrice = Number(bill.base_price ?? 0);
    const total = Number(bill.total_price ?? bill.amount ?? 0);
    const description = bill.description || "";
    const status = bill.status || "pending";
    const servicemanName =
      bill.serviceman_name ||
      (bill.serviceman ? bill.serviceman.full_name : "Not Available");

    // Build invoice text file content
    const invoiceText = `
*************** FIXROUTE INVOICE ***************

Bill ID       : ${bill.id}
Booking ID    : ${bill.booking_id}
Serviceman    : ${servicemanName}
User ID       : ${bill.user_id}

-------------------- CHARGES --------------------

Base Price         : ‚Çπ${basePrice}
Extra Charges      : ‚Çπ${extraCharges}
Spare Part Price   : ‚Çπ${sparePrice}
Price              : ‚Çπ${aiPrice}
Other Fees         : ‚Çπ${otherFees}

-----------------------------------------------
TOTAL AMOUNT       : ‚Çπ${total}
-----------------------------------------------

Status       : ${status}
Created At   : ${bill.created_at}

Notes:
${description || "None"}

************************************************
Powered by FixRoute
************************************************
`;

    // Create a file and download
    const blob = new Blob([invoiceText], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `FixRoute_Invoice_${billId}.txt`;
    a.click();

    URL.revokeObjectURL(url);

  } catch (err) {
    console.error("Download Bill Error:", err);
    alert("Something went wrong while downloading the invoice.");
  }
}
document.getElementById('serviceModal').addEventListener('shown.bs.modal', function () {
    setTimeout(() => {
        if (currentMap) currentMap.resize();
        if (techMap) techMap.resize();
    }, 300);
});


    </script> 

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  </body>
</html>
